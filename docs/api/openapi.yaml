openapi: 3.1.0

info:
  title: LLM Orchestrator API
  version: 0.1.0
  description: |
    Production-grade LLM workflow orchestration platform with state persistence,
    authentication, audit logging, and comprehensive monitoring.

    ## Features
    - Multi-provider LLM orchestration (OpenAI, Anthropic, Cohere)
    - Vector database integration (Pinecone, Weaviate, Qdrant)
    - State persistence with checkpointing
    - JWT and API key authentication
    - Role-based access control (RBAC)
    - Comprehensive audit logging
    - Prometheus metrics
    - Health checks for Kubernetes

    ## Authentication
    This API supports two authentication methods:
    1. **JWT Bearer Token**: Use for user sessions
    2. **API Key**: Use for service-to-service communication

    All endpoints (except `/health/*` and `/metrics`) require authentication.

  contact:
    name: LLM DevOps Team
    email: support@llm-devops.io
    url: https://llm-devops.io/orchestrator
  license:
    name: MIT OR Apache-2.0
    url: https://github.com/llm-devops/llm-orchestrator/blob/main/LICENSE
  termsOfService: https://llm-devops.io/terms

servers:
  - url: http://localhost:8080/api/v1
    description: Local development server
  - url: https://staging-api.llm-orchestrator.io/api/v1
    description: Staging environment
  - url: https://api.llm-orchestrator.io/api/v1
    description: Production environment

security:
  - bearerAuth: []
  - apiKeyAuth: []

tags:
  - name: Authentication
    description: JWT and API key authentication endpoints
  - name: Workflows
    description: Workflow definition and management
  - name: Execution
    description: Workflow execution and control
  - name: State
    description: Workflow state and checkpoint management
  - name: Monitoring
    description: Health checks and metrics
  - name: Admin
    description: Administrative endpoints (requires admin role)
  - name: Audit
    description: Audit log query endpoints

paths:
  # ==================== Authentication Endpoints ====================
  /auth/login:
    post:
      tags: [Authentication]
      summary: Login with credentials
      description: Authenticate with username/password and receive a JWT token
      operationId: login
      security: []  # No auth required for login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password]
              properties:
                username:
                  type: string
                  example: admin
                password:
                  type: string
                  format: password
                  example: secure_password
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'

  /auth/refresh:
    post:
      tags: [Authentication]
      summary: Refresh JWT token
      description: Exchange an existing JWT for a new one with extended expiry
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/keys:
    post:
      tags: [Authentication]
      summary: Create API key
      description: Generate a new API key for service-to-service authentication
      operationId: createApiKey
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApiKeyRequest'
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKey'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      x-required-permissions:
        - AdminAccess

    get:
      tags: [Authentication]
      summary: List API keys
      description: Retrieve all API keys for the authenticated user
      operationId: listApiKeys
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyList'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/keys/{keyId}:
    delete:
      tags: [Authentication]
      summary: Revoke API key
      description: Permanently revoke an API key
      operationId: revokeApiKey
      parameters:
        - name: keyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '204':
          description: API key revoked successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== Workflow Endpoints ====================
  /workflows:
    post:
      tags: [Workflows]
      summary: Create workflow
      description: Create a new workflow definition
      operationId: createWorkflow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Workflow'
          application/yaml:
            schema:
              type: string
              example: |
                name: sentiment-analysis
                version: "1.0"
                steps:
                  - id: analyze
                    type: llm
                    provider: openai
                    model: gpt-4
                    prompt: "Analyze sentiment: {{input}}"
      responses:
        '201':
          description: Workflow created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      x-required-permissions:
        - WorkflowWrite

    get:
      tags: [Workflows]
      summary: List workflows
      description: Retrieve all workflows with optional filtering
      operationId: listWorkflows
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - name: name
          in: query
          description: Filter by workflow name (partial match)
          schema:
            type: string
        - name: version
          in: query
          description: Filter by workflow version
          schema:
            type: string
      responses:
        '200':
          description: List of workflows
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowList'
        '401':
          $ref: '#/components/responses/Unauthorized'
      x-required-permissions:
        - WorkflowRead

  /workflows/{workflowId}:
    get:
      tags: [Workflows]
      summary: Get workflow details
      description: Retrieve complete workflow definition by ID
      operationId: getWorkflow
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
      responses:
        '200':
          description: Workflow details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
      x-required-permissions:
        - WorkflowRead

    put:
      tags: [Workflows]
      summary: Update workflow
      description: Update an existing workflow definition
      operationId: updateWorkflow
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Workflow'
      responses:
        '200':
          description: Workflow updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
      x-required-permissions:
        - WorkflowWrite

    delete:
      tags: [Workflows]
      summary: Delete workflow
      description: Permanently delete a workflow definition
      operationId: deleteWorkflow
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
      responses:
        '204':
          description: Workflow deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Conflict - workflow has active executions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      x-required-permissions:
        - WorkflowDelete

  /workflows/{workflowId}/execute:
    post:
      tags: [Execution]
      summary: Execute workflow
      description: Start a new workflow execution with provided inputs
      operationId: executeWorkflow
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteWorkflowRequest'
      responses:
        '202':
          description: Workflow execution started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
      x-required-permissions:
        - WorkflowExecute

  /workflows/{workflowId}/pause:
    post:
      tags: [Execution]
      summary: Pause workflow execution
      description: Pause a running workflow (if supported by workflow definition)
      operationId: pauseWorkflow
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
        - name: executionId
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Workflow paused successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
      x-required-permissions:
        - ExecutionCancel

  /workflows/{workflowId}/resume:
    post:
      tags: [Execution]
      summary: Resume paused workflow
      description: Resume a paused workflow execution
      operationId: resumeWorkflow
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
        - name: executionId
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Workflow resumed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
      x-required-permissions:
        - WorkflowExecute

  /workflows/{workflowId}/cancel:
    post:
      tags: [Execution]
      summary: Cancel workflow execution
      description: Cancel a running or paused workflow execution
      operationId: cancelWorkflow
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
        - name: executionId
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Workflow cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
      x-required-permissions:
        - ExecutionCancel

  /workflows/{workflowId}/status:
    get:
      tags: [Execution]
      summary: Get execution status
      description: Retrieve current status of a workflow execution
      operationId: getExecutionStatus
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
        - name: executionId
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Execution status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowState'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
      x-required-permissions:
        - ExecutionRead

  # ==================== State Management Endpoints ====================
  /state/{workflowId}:
    get:
      tags: [State]
      summary: Get workflow state
      description: Retrieve current state of a workflow execution
      operationId: getWorkflowState
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
        - name: executionId
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Workflow state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowState'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
      x-required-permissions:
        - ExecutionRead

  /state/{workflowId}/checkpoints:
    get:
      tags: [State]
      summary: List checkpoints
      description: Retrieve all checkpoints for a workflow execution
      operationId: listCheckpoints
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
        - name: executionId
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of checkpoints
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckpointList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
      x-required-permissions:
        - ExecutionRead

    post:
      tags: [State]
      summary: Create checkpoint
      description: Manually create a checkpoint for workflow recovery
      operationId: createCheckpoint
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [executionId, stepId]
              properties:
                executionId:
                  type: string
                  format: uuid
                stepId:
                  type: string
                  example: step-1
      responses:
        '201':
          description: Checkpoint created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Checkpoint'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
      x-required-permissions:
        - WorkflowExecute

  /state/{workflowId}/restore:
    post:
      tags: [State]
      summary: Restore from checkpoint
      description: Restore workflow execution from a specific checkpoint
      operationId: restoreCheckpoint
      parameters:
        - $ref: '#/components/parameters/WorkflowId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [checkpointId]
              properties:
                checkpointId:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Workflow restored successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
      x-required-permissions:
        - WorkflowExecute

  # ==================== Monitoring Endpoints ====================
  /health:
    get:
      tags: [Monitoring]
      summary: Health check
      description: Comprehensive health check including all dependencies
      operationId: healthCheck
      security: []  # No auth required
      responses:
        '200':
          description: System is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResult'
        '503':
          description: System is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResult'

  /health/ready:
    get:
      tags: [Monitoring]
      summary: Readiness probe
      description: Kubernetes readiness probe - checks if service can accept traffic
      operationId: readinessProbe
      security: []  # No auth required
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResult'
        '503':
          description: Service is not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResult'

  /health/live:
    get:
      tags: [Monitoring]
      summary: Liveness probe
      description: Kubernetes liveness probe - checks if service is alive
      operationId: livenessProbe
      security: []  # No auth required
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy]
                  timestamp:
                    type: string
                    format: date-time

  /metrics:
    get:
      tags: [Monitoring]
      summary: Prometheus metrics
      description: Expose metrics in Prometheus format
      operationId: prometheusMetrics
      security: []  # No auth required
      responses:
        '200':
          description: Metrics in Prometheus exposition format
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP orchestrator_workflows_total Total number of workflows
                  # TYPE orchestrator_workflows_total counter
                  orchestrator_workflows_total 42

                  # HELP orchestrator_executions_total Total workflow executions
                  # TYPE orchestrator_executions_total counter
                  orchestrator_executions_total{status="completed"} 38
                  orchestrator_executions_total{status="failed"} 4

  # ==================== Audit Endpoints ====================
  /audit/events:
    get:
      tags: [Audit]
      summary: Query audit events
      description: Retrieve audit events with filtering
      operationId: queryAuditEvents
      parameters:
        - name: user_id
          in: query
          schema:
            type: string
        - name: event_type
          in: query
          schema:
            type: string
            enum:
              - authentication
              - authorization
              - workflow_execution
              - workflow_create
              - workflow_update
              - workflow_delete
              - secret_access
              - config_change
              - api_key_create
              - api_key_revoke
              - step_execution
              - system_event
        - name: resource_type
          in: query
          schema:
            type: string
            enum: [workflow, user, api_key, secret, configuration, step, system]
        - name: resource_id
          in: query
          schema:
            type: string
        - name: start_time
          in: query
          schema:
            type: string
            format: date-time
        - name: end_time
          in: query
          schema:
            type: string
            format: date-time
        - name: result
          in: query
          schema:
            type: string
            enum: [success, failure, partial_success]
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of audit events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditEventList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      x-required-permissions:
        - AdminAccess

  /audit/events/{eventId}:
    get:
      tags: [Audit]
      summary: Get audit event details
      description: Retrieve detailed information for a specific audit event
      operationId: getAuditEvent
      parameters:
        - name: eventId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Audit event details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditEvent'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
      x-required-permissions:
        - AdminAccess

  # ==================== Admin Endpoints ====================
  /admin/users:
    get:
      tags: [Admin]
      summary: List users
      description: Retrieve all users in the system
      operationId: listUsers
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      x-required-permissions:
        - AdminAccess

    post:
      tags: [Admin]
      summary: Create user
      description: Create a new user account
      operationId: createUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: User already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      x-required-permissions:
        - AdminAccess

  /admin/stats:
    get:
      tags: [Admin]
      summary: System statistics
      description: Retrieve aggregated system statistics
      operationId: getSystemStats
      responses:
        '200':
          description: System statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemStats'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      x-required-permissions:
        - AdminAccess

  /admin/secrets:
    post:
      tags: [Admin]
      summary: Manage secrets
      description: Store or update secrets in the secret manager
      operationId: manageSecrets
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [key, value]
              properties:
                key:
                  type: string
                  example: OPENAI_API_KEY
                value:
                  type: string
                  format: password
                  example: sk-...
                ttl_seconds:
                  type: integer
                  description: Time to live in seconds
                  example: 86400
      responses:
        '200':
          description: Secret stored successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  key:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      x-required-permissions:
        - AdminAccess

  /admin/config:
    get:
      tags: [Admin]
      summary: Get system configuration
      description: Retrieve current system configuration (sanitized)
      operationId: getSystemConfig
      responses:
        '200':
          description: System configuration
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      x-required-permissions:
        - AdminAccess

# ==================== Components ====================
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /auth/login

    apiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key obtained from /auth/keys

  parameters:
    WorkflowId:
      name: workflowId
      in: path
      required: true
      description: Unique workflow identifier
      schema:
        type: string
        format: uuid
      example: 550e8400-e29b-41d4-a716-446655440000

    Limit:
      name: limit
      in: query
      description: Maximum number of results to return
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
      example: 20

    Offset:
      name: offset
      in: query
      description: Number of results to skip (for pagination)
      schema:
        type: integer
        minimum: 0
        default: 0
      example: 0

  responses:
    BadRequest:
      description: Bad request - validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: validation_error
            message: Invalid workflow definition
            details:
              errors:
                - field: steps
                  message: Steps array cannot be empty

    Unauthorized:
      description: Unauthorized - missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: unauthorized
            message: Authentication required

    Forbidden:
      description: Forbidden - insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: forbidden
            message: Insufficient permissions
            details:
              required: WorkflowWrite
              available: [WorkflowRead, ExecutionRead]

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: not_found
            message: Workflow not found

    RateLimited:
      description: Too many requests - rate limit exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: Request limit per window
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Remaining requests in current window
        X-RateLimit-Reset:
          schema:
            type: integer
          description: Unix timestamp when the rate limit resets
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: rate_limited
            message: Rate limit exceeded. Please retry after 60 seconds.

  schemas:
    # ==================== Core Domain Models ====================
    Workflow:
      type: object
      required: [name, steps]
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
          description: Unique workflow identifier (auto-generated)
        name:
          type: string
          minLength: 1
          maxLength: 255
          example: sentiment-analysis
        version:
          type: string
          default: "1.0"
          pattern: '^\d+\.\d+$'
          example: "1.0"
        description:
          type: string
          maxLength: 1000
          example: Analyzes sentiment of input text using GPT-4
        steps:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/Step'
        timeout_seconds:
          type: integer
          minimum: 1
          maximum: 3600
          example: 300
        metadata:
          type: object
          additionalProperties: true
          example:
            author: john@example.com
            tags: [nlp, sentiment]

    Step:
      type: object
      required: [id, type]
      properties:
        id:
          type: string
          pattern: '^[a-zA-Z0-9_-]+$'
          example: analyze_sentiment
        type:
          type: string
          enum: [llm, embed, vector_search, transform, action, parallel, branch]
        depends_on:
          type: array
          items:
            type: string
          example: [fetch_context]
        condition:
          type: string
          example: "{{ sentiment }} == 'positive'"
        output:
          type: array
          items:
            type: string
          example: [sentiment, confidence]
        timeout_seconds:
          type: integer
          minimum: 1
        retry:
          $ref: '#/components/schemas/RetryConfig'
      oneOf:
        - $ref: '#/components/schemas/LlmStep'
        - $ref: '#/components/schemas/EmbedStep'
        - $ref: '#/components/schemas/VectorSearchStep'

    LlmStep:
      allOf:
        - type: object
          properties:
            provider:
              type: string
              enum: [openai, anthropic, cohere]
              example: openai
            model:
              type: string
              example: gpt-4
            prompt:
              type: string
              example: "Analyze the sentiment of: {{ input }}"
            temperature:
              type: number
              minimum: 0
              maximum: 2
              example: 0.7
            max_tokens:
              type: integer
              minimum: 1
              maximum: 100000
              example: 1000
            system:
              type: string
              example: You are a helpful sentiment analysis assistant
            stream:
              type: boolean
              default: false

    EmbedStep:
      allOf:
        - type: object
          properties:
            provider:
              type: string
              enum: [openai, cohere]
              example: openai
            model:
              type: string
              example: text-embedding-ada-002
            input:
              type: string
              example: "{{ document_text }}"
            dimensions:
              type: integer
              minimum: 1
            batch_size:
              type: integer
              minimum: 1
              maximum: 100

    VectorSearchStep:
      allOf:
        - type: object
          properties:
            database:
              type: string
              enum: [pinecone, weaviate, qdrant]
              example: pinecone
            index:
              type: string
              example: documents
            query:
              type: string
              example: "{{ embedding }}"
            top_k:
              type: integer
              minimum: 1
              maximum: 100
              default: 5
            filter:
              type: object
              additionalProperties: true
            namespace:
              type: string
            include_metadata:
              type: boolean
              default: true
            include_vectors:
              type: boolean
              default: false

    RetryConfig:
      type: object
      properties:
        max_attempts:
          type: integer
          minimum: 1
          maximum: 10
          default: 3
        backoff:
          type: string
          enum: [exponential, linear, constant]
          default: exponential
        initial_delay_ms:
          type: integer
          minimum: 0
          default: 100
        max_delay_ms:
          type: integer
          minimum: 0
          default: 30000

    # ==================== Execution Models ====================
    ExecuteWorkflowRequest:
      type: object
      required: [inputs]
      properties:
        inputs:
          type: object
          additionalProperties: true
          example:
            text: This is a great product!
        async:
          type: boolean
          default: true
          description: If true, returns immediately with execution ID
        timeout_override:
          type: integer
          minimum: 1
          description: Override workflow timeout in seconds

    ExecutionResponse:
      type: object
      properties:
        execution_id:
          type: string
          format: uuid
        workflow_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, running, paused, completed, failed]
        started_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        outputs:
          type: object
          additionalProperties: true
        error:
          type: string

    WorkflowState:
      type: object
      properties:
        id:
          type: string
          format: uuid
        workflow_id:
          type: string
        workflow_name:
          type: string
        status:
          type: string
          enum: [pending, running, paused, completed, failed]
        user_id:
          type: string
        started_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        context:
          type: object
          additionalProperties: true
        error:
          type: string
        steps:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/StepState'

    StepState:
      type: object
      properties:
        step_id:
          type: string
        status:
          type: string
          enum: [pending, running, completed, failed, skipped]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        outputs:
          type: object
          additionalProperties: true
        error:
          type: string
        retry_count:
          type: integer

    Checkpoint:
      type: object
      properties:
        id:
          type: string
          format: uuid
        workflow_state_id:
          type: string
          format: uuid
        step_id:
          type: string
        timestamp:
          type: string
          format: date-time
        snapshot:
          type: object
          additionalProperties: true

    # ==================== Authentication Models ====================
    LoginResponse:
      type: object
      properties:
        access_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refresh_token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        token_type:
          type: string
          enum: [Bearer]
          example: Bearer
        expires_in:
          type: integer
          description: Token expiry in seconds
          example: 3600
        user_id:
          type: string
        roles:
          type: array
          items:
            type: string
          example: [developer]

    CreateApiKeyRequest:
      type: object
      required: [scopes]
      properties:
        name:
          type: string
          maxLength: 255
          example: Production API Key
        scopes:
          type: array
          items:
            type: string
          example: [workflow:read, workflow:execute]
        expires_in_days:
          type: integer
          minimum: 1
          maximum: 365
          example: 90

    ApiKey:
      type: object
      properties:
        id:
          type: string
          format: uuid
        key:
          type: string
          description: Raw API key (only returned on creation)
          example: llo_sk_1234567890abcdef
        key_hash:
          type: string
          readOnly: true
        user_id:
          type: string
        scopes:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        name:
          type: string

    ApiKeyInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        key_hash:
          type: string
        user_id:
          type: string
        scopes:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        name:
          type: string
        last_used_at:
          type: string
          format: date-time

    # ==================== Audit Models ====================
    AuditEvent:
      type: object
      properties:
        id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        event_type:
          type: string
          enum:
            - authentication
            - authorization
            - workflow_execution
            - workflow_create
            - workflow_update
            - workflow_delete
            - secret_access
            - config_change
            - api_key_create
            - api_key_revoke
            - step_execution
            - system_event
        user_id:
          type: string
        action:
          type: string
        resource_type:
          type: string
          enum: [workflow, user, api_key, secret, configuration, step, system]
        resource_id:
          type: string
        result:
          type: string
          enum: [success, failure, partial_success]
        details:
          type: object
          additionalProperties: true
        ip_address:
          type: string
        user_agent:
          type: string
        request_id:
          type: string
        event_hash:
          type: string
          description: SHA-256 hash for tamper detection

    # ==================== Monitoring Models ====================
    HealthCheckResult:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time
        checks:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ComponentHealth'
        message:
          type: string

    ComponentHealth:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        response_time_ms:
          type: integer
        error:
          type: string
        last_check:
          type: string
          format: date-time

    # ==================== Admin Models ====================
    User:
      type: object
      properties:
        id:
          type: string
        username:
          type: string
        email:
          type: string
          format: email
        roles:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        last_login:
          type: string
          format: date-time

    CreateUserRequest:
      type: object
      required: [username, email, password, roles]
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
        email:
          type: string
          format: email
        password:
          type: string
          format: password
          minLength: 8
        roles:
          type: array
          items:
            type: string
            enum: [viewer, executor, developer, admin]

    SystemStats:
      type: object
      properties:
        total_workflows:
          type: integer
        total_executions:
          type: integer
        executions_by_status:
          type: object
          properties:
            pending:
              type: integer
            running:
              type: integer
            completed:
              type: integer
            failed:
              type: integer
        active_users:
          type: integer
        api_keys_count:
          type: integer
        avg_execution_time_ms:
          type: number
        uptime_seconds:
          type: integer

    # ==================== List Response Models ====================
    WorkflowResponse:
      allOf:
        - $ref: '#/components/schemas/Workflow'
        - type: object
          properties:
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time
            created_by:
              type: string

    WorkflowList:
      type: object
      properties:
        workflows:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowResponse'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    ApiKeyList:
      type: object
      properties:
        keys:
          type: array
          items:
            $ref: '#/components/schemas/ApiKeyInfo'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    CheckpointList:
      type: object
      properties:
        checkpoints:
          type: array
          items:
            $ref: '#/components/schemas/Checkpoint'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    AuditEventList:
      type: object
      properties:
        events:
          type: array
          items:
            $ref: '#/components/schemas/AuditEvent'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    UserList:
      type: object
      properties:
        users:
          type: array
          items:
            $ref: '#/components/schemas/User'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    # ==================== Error Model ====================
    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          enum:
            - validation_error
            - unauthorized
            - forbidden
            - not_found
            - conflict
            - rate_limited
            - internal_error
          example: validation_error
        message:
          type: string
          example: Invalid workflow definition
        details:
          type: object
          additionalProperties: true
        request_id:
          type: string
          format: uuid
